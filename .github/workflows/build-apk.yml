name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Debug Environment
        run: |
          node -v
          npm -v
          ls -R public

      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps
          npm install @capacitor/cli@5 @capacitor/core@5 @capacitor/android@5 --legacy-peer-deps

      - name: Capacitor Sync
        run: |
          npx cap add android || echo "Android platform already exists"
          npx cap sync android

      - name: Patch Android Project
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          VARS="android/variables.gradle"
          
          if [ -f "$VARS" ]; then
            sed -i 's/compileSdkVersion = [0-9]*/compileSdkVersion = 34/' "$VARS"
            sed -i 's/targetSdkVersion = [0-9]*/targetSdkVersion = 34/' "$VARS"
            echo "SDK 34 applied to $VARS"
          fi

          if [ -f "$MANIFEST" ]; then
            # Simple, non-destructive sed inserts
            sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' "$MANIFEST"
            sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />' "$MANIFEST"
            sed -i '/<manifest/a \    <uses-permission android:name="android.permission.WAKE_LOCK" />' "$MANIFEST"
            sed -i '/<manifest/a \    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />' "$MANIFEST"
            sed -i '/<manifest/a \    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' "$MANIFEST"
            # Add Foreground Service declaration if it doesn't exist
            if ! grep -q "AndroidForegroundService" "$MANIFEST"; then
              sed -i '/<\/activity>/a \        <service android:name="io.capawesome.capacitor.plugins.androidforegroundservice.AndroidForegroundService" android:foregroundServiceType="mediaPlayback" android:exported="false" />' "$MANIFEST"
            fi
            echo "Manifest patched"
            cat "$MANIFEST" # Debug output to see final manifest
          fi

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build APK (with Debug Output)
        working-directory: ./android
        run: |
          ./gradlew clean
          ./gradlew assembleDebug --stacktrace --info

      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tag_name: latest
          name: Latest Build
          files: android/app/build/outputs/apk/debug/app-debug.apk
          body: |
            This is the latest automated build of AudioPorter.
            Includes background audio fixes for Android 14.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
